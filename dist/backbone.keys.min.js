/*!
 * Backbone.keys.js v0.2.0
 * Copyright 2012, Raymond Julin (@nervetattoo)
 * backbone.keys.js may be freely distributed under the MIT license.
 */(function(e){"use strict";"function"==typeof define&&define.amd?define(["underscore","backbone","jquery"],e):e(_,Backbone,$)})(function(e,t){"use strict";var i=t.View.prototype.delegateEvents,n=t.View.prototype.undelegateEvents,s=function(e){return 1===e.length?e.toUpperCase().charCodeAt(0):r[e]},r={backspace:8,tab:9,enter:13,space:32,shift:16,ctrl:17,alt:18,meta:91,caps_lock:20,esc:27,num_lock:144,page_up:33,page_down:34,end:35,home:36,left:37,up:38,right:39,down:40,insert:45,"delete":46,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,fslash:191};return e.each({options:"alt","return":"enter"},function(e,t){r[t]=r[e]}),t.View=t.View.extend({bindKeysOn:"keyup",_keyEventBindings:null,delegateEvents:function(){return i.apply(this,Array.prototype.slice.apply(arguments)),this.delegateKeys(),this},undelegateEvents:function(){return this.undelegateKeys(),n.apply(this,arguments),this},delegateKeys:function(t){return this.undelegateKeys(),this.bindTo=[],t=t||this.keys,t&&(e.each(t,function(t,i){var n={},s=i,r="";i.indexOf(" ")>=0&&(s=i.split(" ")[0],r=i.substring(i.indexOf(" ")+1));var o;o=e.isFunction(t)?t:e.isFunction(t.action)?t.action:t.action?this[t.action]:this[t],n.on=t.on||this.bindKeysOn,n.action=o,n.target=r,this.bindTo.push(n);var h=s.replace(/,/g," ");this.keyOn(h,n)},this),this.bindTo=e.uniq(this.bindTo,!1,function(e){return"on:"+e.on+"|target:"+e.target}),e.each(this.bindTo,function(t){var i={view:this,target:t.target};""!==t.target&&this.$el?this.$el.on(t.on,t.target,e.bind(this.triggerKey,i)):this.$el.on(t.on,e.bind(this.triggerKey,i))},this)),this},undelegateKeys:function(){return this._keyEventBindings={},this.$el&&(this.$el.off("keyup"),this.$el.off("keydown")),this.bindTo&&(e.each(this.bindTo,function(e){e&&this.$el&&this.$el.find(e.target).off(e.on)},this),this.bindTo=null),this},keyName:function(e){var t;for(t in r)if(r[t]===e)return t;return String.fromCharCode(e)},triggerKey:function(t){var i;return e.isObject(t)?i=t.which:e.isString(t)?i=s(t):e.isNumber(t)&&(i=t),"keydown"!==t.type||this.view.ctrlPressed||(this.view.ctrlPressed=t.ctrlKey),"keydown"!==t.type||this.view.altPressed||(this.view.altPressed=t.altKey),e(this.view._keyEventBindings[i]).each(function(i){if(i.target===this.target){var n=t.type===i.on;if(i.modifiers.length>0)n=n&&e(i.modifiers).all(function(e){return t[e+"Key"]===!0});else if(this.view.ctrlPressed||this.view.altPressed)return;if(n&&i.method){if(this.view.preventKeyboardAction===!0)return t.stopPropagation(),void 0;i.method(t,i.key)}}},this),"keyup"===t.type&&this.view.ctrlPressed&&(this.view.ctrlPressed=t.ctrlKey),"keyup"===t.type&&this.view.altPressed&&(this.view.altPressed=t.altKey),this.view},keyOn:function(t,i){t=t.split(" ");{if(!(t.length>1)){t=t.pop().toLowerCase();var n=t.split("+");t=n.shift();var r=s(t);return this._keyEventBindings.hasOwnProperty(r)||(this._keyEventBindings[r]=[]),this._keyEventBindings[r].push({key:t,modifiers:n||!1,method:i.action?e.bind(i.action,this):null,on:i.on,target:i.target}),this}for(var o=t.length;o--;)this.keyOn(t[o],i)}},keyOff:function(t,i){if(i=i||!1,null===t)return this._keyEventBindings={},this;var n=s(t);return e.isFunction(i)||(i=this[i]),i?(this._keyEventBindings[n]=e.filter(this._keyEventBindings[n],function(e){return e.method===i}),this):(this._keyEventBindings[n]=[],this)}}),t});